<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Church Translation</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useRef } = React;

        // Lucide icons as inline SVG components
        const Mic = ({ className }) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
        );
        
        const MicOff = ({ className }) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="2" x2="22" y1="2" y2="22"/><path d="M18.89 13.23A7.12 7.12 0 0 0 19 12v-2"/><path d="M5 10v2a7 7 0 0 0 12 5"/><path d="M15 9.34V5a3 3 0 0 0-5.68-1.33"/><path d="M9 9v3a3 3 0 0 0 5.12 2.12"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
        );
        
        const Volume2 = ({ className }) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>
        );
        
        const VolumeX = ({ className }) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="22" x2="16" y1="9" y2="15"/><line x1="16" x2="22" y1="9" y2="15"/></svg>
        );
        
        const Users = ({ className }) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        );
        
        const Radio = ({ className }) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="2"/><path d="M4.93 19.07a10 10 0 0 1 0-14.14"/><path d="M7.76 16.24a6 6 0 0 1 0-8.49"/><path d="M16.24 7.76a6 6 0 0 1 0 8.49"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>
        );
        
        const Lock = ({ className }) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        );
        
        const AlertCircle = ({ className }) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>
        );

        function ChurchTranslationApp() {
          const [mode, setMode] = useState(null);
          const [showTranslatorAuth, setShowTranslatorAuth] = useState(false);
          const [translatorPassword, setTranslatorPassword] = useState('');
          const [sessionCode, setSessionCode] = useState('');
          const [inputCode, setInputCode] = useState('');
          const [isStreaming, setIsStreaming] = useState(false);
          const [isListening, setIsListening] = useState(false);
          const [isMuted, setIsMuted] = useState(false);
          const [listenerCount, setListenerCount] = useState(0);
          const [error, setError] = useState('');
          const [roomUrl, setRoomUrl] = useState('');
          const [isConnecting, setIsConnecting] = useState(false);
          
          const callFrameRef = useRef(null);
          const TRANSLATOR_PASSWORD = 'GlorytoGod2025';
          
          // REPLACE THIS WITH YOUR DAILY.CO API KEY
          const DAILY_API_KEY = 'a0c0a79c192e0313662243e131e6df612b5a53bed5c02d33195166c3cf481e58';

          const generateSessionCode = (roomName) => {
            const hash = roomName.split('-').pop();
            return hash.substring(0, 4).toUpperCase();
          };

          const createDailyRoom = async () => {
            try {
              const response = await fetch('https://api.daily.co/v1/rooms', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${DAILY_API_KEY}`
                },
                body: JSON.stringify({
                  properties: {
                    enable_chat: false,
                    enable_screenshare: false,
                    enable_recording: false,
                    start_video_off: true,
                    start_audio_off: false,
                    exp: Math.floor(Date.now() / 1000) + (4 * 60 * 60)
                  }
                })
              });

              if (!response.ok) {
                throw new Error('Failed to create room');
              }

              const room = await response.json();
              return room;
            } catch (err) {
              console.error('Room creation error:', err);
              throw err;
            }
          };

          const verifyTranslatorAccess = () => {
            if (translatorPassword === TRANSLATOR_PASSWORD) {
              setMode('translator');
              setShowTranslatorAuth(false);
              setTranslatorPassword('');
              setError('');
            } else {
              setError('Incorrect password. Please try again.');
            }
          };

          const startTranslating = async () => {
            try {
              setError('');
              setIsConnecting(true);

              const room = await createDailyRoom();
              const code = generateSessionCode(room.name);
              
              setRoomUrl(room.url);
              setSessionCode(code);

              if (!window.DailyIframe) {
                await new Promise((resolve, reject) => {
                  const script = document.createElement('script');
                  script.src = 'https://unpkg.com/@daily-co/daily-js';
                  script.onload = resolve;
                  script.onerror = reject;
                  document.body.appendChild(script);
                });
              }

              const callFrame = window.DailyIframe.createFrame({
                showLeaveButton: false,
                showFullscreenButton: false,
                iframeStyle: {
                  position: 'fixed',
                  top: '0',
                  left: '0',
                  width: '0',
                  height: '0',
                  visibility: 'hidden'
                }
              });

              callFrameRef.current = callFrame;

              await callFrame.join({ 
                url: room.url,
                userName: 'Translator'
              });

              await callFrame.setLocalAudio(true);
              
              callFrame.on('participant-joined', () => {
                const participants = callFrame.participants();
                setListenerCount(Object.keys(participants).length - 1);
              });

              callFrame.on('participant-left', () => {
                const participants = callFrame.participants();
                setListenerCount(Object.keys(participants).length - 1);
              });

              setIsStreaming(true);
              setIsConnecting(false);

            } catch (err) {
              setError('Could not start translation. Please check your microphone and try again.');
              console.error('Translation start error:', err);
              setIsConnecting(false);
            }
          };

          const stopTranslating = async () => {
            if (callFrameRef.current) {
              await callFrameRef.current.leave();
              await callFrameRef.current.destroy();
              callFrameRef.current = null;
            }
            setIsStreaming(false);
            setSessionCode('');
            setRoomUrl('');
            setListenerCount(0);
          };

          const findRoomByCode = async (code) => {
            try {
              const response = await fetch('https://api.daily.co/v1/rooms', {
                headers: {
                  'Authorization': `Bearer ${DAILY_API_KEY}`
                }
              });

              if (!response.ok) {
                throw new Error('Failed to fetch rooms');
              }

              const rooms = await response.json();
              
              for (const room of rooms.data) {
                const roomCode = generateSessionCode(room.name);
                if (roomCode === code.toUpperCase()) {
                  return room;
                }
              }
              
              return null;
            } catch (err) {
              console.error('Room search error:', err);
              throw err;
            }
          };

          const joinSession = async () => {
            if (inputCode.length !== 4) {
              setError('Please enter a valid 4-digit code');
              return;
            }
            
            try {
              setError('');
              setIsConnecting(true);

              const room = await findRoomByCode(inputCode);
              
              if (!room) {
                setError('Session not found. Please check the code.');
                setIsConnecting(false);
                return;
              }

              setRoomUrl(room.url);
              setSessionCode(inputCode.toUpperCase());

              if (!window.DailyIframe) {
                await new Promise((resolve, reject) => {
                  const script = document.createElement('script');
                  script.src = 'https://unpkg.com/@daily-co/daily-js';
                  script.onload = resolve;
                  script.onerror = reject;
                  document.body.appendChild(script);
                });
              }

              const callFrame = window.DailyIframe.createFrame({
                showLeaveButton: false,
                showFullscreenButton: false,
                iframeStyle: {
                  position: 'fixed',
                  top: '0',
                  left: '0',
                  width: '0',
                  height: '0',
                  visibility: 'hidden'
                }
              });

              callFrameRef.current = callFrame;

              await callFrame.join({ 
                url: room.url,
                userName: 'Listener'
              });

              await callFrame.setLocalAudio(false);

              setIsListening(true);
              setIsConnecting(false);

            } catch (err) {
              setError('Could not connect to session. Please try again.');
              console.error('Connection error:', err);
              setIsConnecting(false);
            }
          };

          const leaveSession = async () => {
            if (callFrameRef.current) {
              await callFrameRef.current.leave();
              await callFrameRef.current.destroy();
              callFrameRef.current = null;
            }
            setIsListening(false);
            setSessionCode('');
            setInputCode('');
            setRoomUrl('');
            setIsMuted(false);
          };

          const toggleMute = () => {
            const newMutedState = !isMuted;
            setIsMuted(newMutedState);
            
            if (callFrameRef.current) {
              const participants = callFrameRef.current.participants();
              Object.keys(participants).forEach(id => {
                if (id !== 'local') {
                  callFrameRef.current.updateParticipant(id, {
                    setAudio: !newMutedState
                  });
                }
              });
            }
          };

          const resetMode = async () => {
            if (isStreaming) await stopTranslating();
            if (isListening) await leaveSession();
            setMode(null);
            setError('');
            setShowTranslatorAuth(false);
            setTranslatorPassword('');
          };

          if (showTranslatorAuth) {
            return (
              <div className="min-h-screen bg-gradient-to-r from-black via-gray-700 to-black p-4 flex items-center justify-center">
                <div className="max-w-md w-full bg-white rounded-3xl shadow-2xl p-8">
                  <div className="text-center mb-8">
                    <div className="inline-flex items-center justify-center w-16 h-16 bg-black rounded-full mb-6">
                      <Lock className="w-7 h-7 text-white" />
                    </div>
                    <h2 className="text-3xl font-light text-black mb-2">Translator Access</h2>
                    <p className="text-gray-500 text-sm font-light">Enter password to continue</p>
                  </div>

                  {error && (
                    <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-2xl text-red-600 text-sm font-light">
                      {error}
                    </div>
                  )}

                  <div className="space-y-4">
                    <input
                      type="password"
                      value={translatorPassword}
                      onChange={(e) => setTranslatorPassword(e.target.value)}
                      onKeyPress={(e) => e.key === 'Enter' && verifyTranslatorAccess()}
                      placeholder="Password"
                      className="w-full px-5 py-4 bg-gray-50 border border-gray-200 rounded-2xl focus:border-black focus:outline-none font-light text-lg transition-all"
                    />
                    
                    <button
                      onClick={verifyTranslatorAccess}
                      className="w-full bg-black hover:bg-gray-900 text-white font-light py-4 px-6 rounded-2xl transition-all text-lg"
                    >
                      Continue
                    </button>

                    <button
                      onClick={() => {
                        setShowTranslatorAuth(false);
                        setTranslatorPassword('');
                        setError('');
                      }}
                      className="w-full bg-white hover:bg-gray-50 text-black font-light py-4 px-6 rounded-2xl transition-all border border-gray-200 text-lg"
                    >
                      Cancel
                    </button>
                  </div>

                  <div className="mt-8 p-4 bg-gray-50 rounded-2xl">
                    <p className="text-xs text-gray-400 text-center font-light">
                      Demo password: <span className="font-mono font-medium text-gray-600">translate2024</span>
                    </p>
                  </div>
                </div>
              </div>
            );
          }

          if (!mode) {
            return (
              <div className="min-h-screen bg-gradient-to-r from-black via-gray-700 to-black p-4 flex items-center justify-center">
                <div className="max-w-md w-full bg-white rounded-3xl shadow-2xl p-10">
                  <div className="text-center mb-10">
                    <div className="inline-flex items-center justify-center w-20 h-20 bg-black rounded-full mb-6">
                      <Radio className="w-9 h-9 text-white" />
                    </div>
                    <h1 className="text-4xl font-light text-black mb-3">Translation</h1>
                    <p className="text-gray-500 font-light">Live sermon audio service</p>
                  </div>
                  
                  <button
                    onClick={() => setMode('listener')}
                    className="w-full bg-black hover:bg-gray-900 text-white font-light py-5 px-6 rounded-2xl transition-all flex items-center justify-center gap-3 text-lg"
                  >
                    <Volume2 className="w-5 h-5" />
                    Join Translation
                  </button>

                  <div className="mt-10 text-center">
                    <button
                      onClick={() => setShowTranslatorAuth(true)}
                      className="text-xs text-gray-400 hover:text-gray-600 transition-colors font-light"
                    >
                      Translator Access
                    </button>
                  </div>
                </div>
              </div>
            );
          }

          if (mode === 'translator') {
            return (
              <div className="min-h-screen bg-gradient-to-r from-black via-gray-700 to-black p-4">
                <div className="max-w-md mx-auto">
                  <button
                    onClick={resetMode}
                    className="mb-6 text-white hover:text-gray-300 font-light flex items-center gap-2"
                  >
                    ‚Üê Back
                  </button>
                  
                  <div className="bg-white rounded-3xl shadow-2xl p-8">
                    <div className="text-center mb-8">
                      <div className="inline-flex items-center justify-center w-16 h-16 bg-black rounded-full mb-6">
                        <Mic className="w-7 h-7 text-white" />
                      </div>
                      <h2 className="text-3xl font-light text-black mb-2">Translator Mode</h2>
                      <p className="text-gray-500 font-light text-sm">Broadcast live translation</p>
                    </div>

                    {error && (
                      <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-2xl text-red-600 text-sm font-light flex items-start gap-2">
                        <AlertCircle className="w-4 h-4 mt-0.5 flex-shrink-0" />
                        <span>{error}</span>
                      </div>
                    )}

                    {!isStreaming ? (
                      <button
                        onClick={startTranslating}
                        disabled={isConnecting}
                        className="w-full bg-black hover:bg-gray-900 disabled:bg-gray-400 text-white font-light py-5 px-6 rounded-2xl transition-all flex items-center justify-center gap-3 text-lg"
                      >
                        {isConnecting ? (
                          <>
                            <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                            Connecting...
                          </>
                        ) : (
                          <>
                            <Mic className="w-5 h-5" />
                            Start Translation
                          </>
                        )}
                      </button>
                    ) : (
                      <div className="space-y-6">
                        <div className="bg-black rounded-2xl p-6 text-center">
                          <div className="inline-flex items-center justify-center w-12 h-12 bg-white rounded-full mb-4">
                            <Mic className="w-6 h-6 text-black animate-pulse" />
                          </div>
                          <p className="text-white font-light mb-1 text-lg">Broadcasting Live</p>
                          <p className="text-gray-400 text-sm font-light">Audio is transmitting</p>
                        </div>

                        <div className="bg-gray-50 rounded-2xl p-8 text-center">
                          <p className="text-gray-500 text-xs mb-3 font-light uppercase tracking-wider">Session Code</p>
                          <p className="text-6xl font-light text-black tracking-widest mb-4">{sessionCode}</p>
                          <p className="text-gray-500 text-sm font-light">Share with listeners</p>
                        </div>

                        <div className="flex items-center justify-center gap-3 text-gray-700 py-4">
                          <Users className="w-5 h-5" />
                          <span className="font-light text-2xl">{listenerCount}</span>
                          <span className="text-sm font-light text-gray-500">listener{listenerCount !== 1 ? 's' : ''}</span>
                        </div>

                        <button
                          onClick={stopTranslating}
                          className="w-full bg-white hover:bg-gray-50 text-black font-light py-5 px-6 rounded-2xl transition-all flex items-center justify-center gap-3 border border-gray-200 text-lg"
                        >
                          <MicOff className="w-5 h-5" />
                          Stop Translation
                        </button>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            );
          }

          if (mode === 'listener') {
            return (
              <div className="min-h-screen bg-gradient-to-r from-black via-gray-700 to-black p-4">
                <div className="max-w-md mx-auto">
                  <button
                    onClick={resetMode}
                    className="mb-6 text-white hover:text-gray-300 font-light flex items-center gap-2"
                  >
                    ‚Üê Back
                  </button>
                  
                  <div className="bg-white rounded-3xl shadow-2xl p-8">
                    <div className="text-center mb-8">
                      <div className="inline-flex items-center justify-center w-16 h-16 bg-black rounded-full mb-6">
                        <Volume2 className="w-7 h-7 text-white" />
                      </div>
                      <h2 className="text-3xl font-light text-black mb-2">Listen</h2>
                      <p className="text-gray-500 font-light text-sm">Enter code from screen</p>
                    </div>

                    {error && (
                      <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-2xl text-red-600 text-sm font-light flex items-start gap-2">
                        <AlertCircle className="w-4 h-4 mt-0.5 flex-shrink-0" />
                        <span>{error}</span>
                      </div>
                    )}

                    {!isListening ? (
                      <div className="space-y-6">
                        <div>
                          <label className="block text-gray-500 font-light mb-3 text-sm uppercase tracking-wider">Session Code</label>
                          <input
                            type="text"
                            maxLength="4"
                            value={inputCode}
                            onChange={(e) => setInputCode(e.target.value.replace(/\D/g, ''))}
                            placeholder="1234"
                            className="w-full text-center text-5xl font-light tracking-widest px-4 py-6 bg-gray-50 border border-gray-200 rounded-2xl focus:border-black focus:outline-none transition-all"
                          />
                        </div>
                        
                        <button
                          onClick={joinSession}
                          disabled={inputCode.length !== 4 || isConnecting}
                          className="w-full bg-black hover:bg-gray-900 disabled:bg-gray-300 disabled:cursor-not-allowed text-white font-light py-5 px-6 rounded-2xl transition-all flex items-center justify-center gap-3 text-lg"
                        >
                          {isConnecting ? (
                            <>
                              <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                              Connecting...
                            </>
                          ) : (
                            <>
                              <Volume2 className="w-5 h-5" />
                              Join Session
                            </>
                          )}
                        </button>
                      </div>
                    ) : (
                      <div className="space-y-6">
                        <div className="bg-black rounded-2xl p-6 text-center">
                          <div className="inline-flex items-center justify-center w-12 h-12 bg-white rounded-full mb-4">
                            {isMuted ? <VolumeX className="w-6 h-6 text-black" /> : <Volume2 className="w-6 h-6 text-black animate-pulse" />}
                          </div>
                          <p className="text-white font-light mb-1 text-lg">
                            {isMuted ? 'Audio Muted' : 'Receiving Audio'}
                          </p>
                          <p className="text-gray-400 text-sm font-light">Session {sessionCode}</p>
                        </div>

                        <div className="bg-gray-50 border border-gray-200 rounded-2xl p-5">
                          <p className="text-gray-600 text-sm text-center font-light">
                            üéß Use headphones to prevent feedback
                          </p>
                        </div>

                        <button
                          onClick={toggleMute}
                          className="w-full bg-gray-50 hover:bg-gray-100 text-black font-light py-5 px-6 rounded-2xl transition-all flex items-center justify-center gap-3 border border-gray-200 text-lg"
                        >
                          {isMuted ? <VolumeX className="w-5 h-5" /> : <Volume2 className="w-5 h-5" />}
                          {isMuted ? 'Unmute' : 'Mute'}
                        </button>

                        <button
                          onClick={leaveSession}
                          className="w-full bg-white hover:bg-gray-50 text-black font-light py-5 px-6 rounded-2xl transition-all border border-gray-200 text-lg"
                        >
                          Leave Session
                        </button>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            );
          }
        }

        ReactDOM.render(<ChurchTranslationApp />, document.getElementById('root'));
    </script>
</body>
</html>
